# IVF ç´¢å¼• nprobe è°ƒä¼˜æŒ‡å—

## ä»€ä¹ˆæ˜¯ nprobeï¼Ÿ

`nprobe` æ˜¯ IVF (Inverted File) ç´¢å¼•çš„å…³é”®å‚æ•°ï¼Œæ§åˆ¶æœç´¢æ—¶æŸ¥è¯¢çš„**èšç±»æ•°é‡**ï¼š

```
IVF ç´¢å¼•ç»“æ„:
- å‘é‡è¢«åˆ†åˆ° nlist ä¸ªèšç±»ä¸­
- æœç´¢æ—¶åªæŸ¥è¯¢æœ€è¿‘çš„ nprobe ä¸ªèšç±»
- nprobe è¶Šå¤§ â†’ å¬å›ç‡è¶Šé«˜ï¼Œé€Ÿåº¦è¶Šæ…¢
- nprobe è¶Šå° â†’ é€Ÿåº¦è¶Šå¿«ï¼Œå¬å›ç‡è¶Šä½
```

## å¿«é€Ÿè°ƒä¼˜

### ä½¿ç”¨æ¨èå€¼

```python
from nexus_mind.infrastructure.storage.vector.faiss_backend import FAISSBackend

backend = FAISSBackend(dim=768, index_type='ivf', use_gpu=True)
backend.build(vectors)

# è·å–æ¨è nprobe
nprobe = backend.recommend_nprobe(target_recall=0.95)
print(f"Recommended nprobe: {nprobe}")  # ä¾‹å¦‚: 800

# è®¾ç½® nprobe
backend.set_nprobe(nprobe)

# æœç´¢
scores, indices = backend.search(query, top_k=10)
```

### å‘½ä»¤è¡Œè°ƒä¼˜å·¥å…·

```bash
# è‡ªåŠ¨è°ƒä¼˜ nprobe
python tools/nprobe_tuner.py --benchmark --scale 50000 --target-recall 0.95

# è¾“å‡ºç¤ºä¾‹:
# nprobe=   1: recall=0.125, P50=0.11ms
# nprobe=  50: recall=0.515, P50=0.11ms
# nprobe= 400: recall=0.793, P50=0.12ms
# nprobe= 800: recall=0.938, P50=0.15ms  <-- æ¨èå€¼
```

## nprobe vs å¬å›ç‡å‚è€ƒè¡¨

åŸºäº 50K-100K å‘é‡ã€èšç±»åˆ†å¸ƒæ•°æ®çš„æµ‹è¯•ç»“æœï¼š

| nprobe (å  nlist%) | é¢„æœŸå¬å›ç‡ | é€Ÿåº¦å½±å“ | é€‚ç”¨åœºæ™¯ |
|-------------------|-----------|---------|---------|
| 1 (0.1%) | ~5-15% | âš¡ æœ€å¿« | å¿«é€Ÿé¢„è§ˆ |
| 4% | ~50% | âš¡ å¿« | ç²—ç­› |
| 8% | ~60% | âš¡ å¿« | ç²—ç­› |
| 16% | ~70% | ğŸš€ è¾ƒå¿« | å¹³è¡¡ |
| 32% | ~80% | ğŸš€ è¾ƒå¿« | å¹³è¡¡ |
| **64%** | **~95%** | â±ï¸ ä¸­ç­‰ | **æ¨è** |
| 80% | ~99% | â±ï¸ è¾ƒæ…¢ | é«˜ç²¾åº¦ |
| 100% | 100% | ğŸ¢ æœ€æ…¢ | ç²¾ç¡®æœç´¢ |

## ä¸åŒåœºæ™¯çš„æ¨èé…ç½®

### åœºæ™¯ 1: å®æ—¶æœç´¢ (é€Ÿåº¦ä¼˜å…ˆ)
```python
backend.set_nprobe(backend.nlist // 16)  # ~6% of clusters
# é¢„æœŸ: 60-70% å¬å›ç‡, é€Ÿåº¦æå¿«
```

### åœºæ™¯ 2: å¹³è¡¡æ¨¡å¼ (æ¨è)
```python
nprobe = backend.recommend_nprobe(0.95)  # ~64% of clusters
backend.set_nprobe(nprobe)
# é¢„æœŸ: 95% å¬å›ç‡, é€Ÿåº¦è‰¯å¥½
```

### åœºæ™¯ 3: é«˜ç²¾åº¦æœç´¢
```python
backend.set_nprobe(int(backend.nlist * 0.8))  # 80% of clusters
# é¢„æœŸ: 99% å¬å›ç‡, é€Ÿåº¦è¾ƒæ…¢
```

## å®é™…æµ‹è¯•æ•°æ®

### 5ä¸‡å‘é‡ IVF ç´¢å¼• (nlist=1258)

| nprobe | å¬å›ç‡ | P50 å»¶è¿Ÿ | ç›¸æ¯” nprobe=1 |
|-------|-------|---------|--------------|
| 1 | 4.9% | 0.11ms | 1.0x |
| 50 | 51.5% | 0.11ms | 1.0x |
| 100 | 59.5% | 0.11ms | 1.0x |
| 200 | 67.5% | 0.12ms | 1.1x |
| 400 | 79.3% | 0.12ms | 1.1x |
| **800** | **93.8%** | **0.15ms** | **1.4x** |
| 1258 | 100.0% | 0.18ms | 1.6x |

**ç»“è®º**: nprobe=800 è¾¾åˆ° 93.8% å¬å›ç‡ï¼Œä½†é€Ÿåº¦åªæ…¢ 1.4xï¼Œæ˜¯æœ€ä½³å¹³è¡¡ç‚¹ã€‚

## å½±å“å› ç´ 

### 1. æ•°æ®åˆ†å¸ƒ
- **èšç±»æ˜æ˜¾**: nprobe å¯ä»¥è¾ƒå° (5-10%)
- **åˆ†å¸ƒå‡åŒ€**: éœ€è¦è¾ƒå¤§ nprobe (30-50%)

### 2. ç´¢å¼•è§„æ¨¡
- **å°æ•°æ®é›† (<10K)**: ä½¿ç”¨ Flat ç´¢å¼•ï¼Œæ— éœ€è°ƒä¼˜
- **ä¸­æ•°æ®é›† (10K-100K)**: nprobe = 10-30% of nlist
- **å¤§æ•°æ®é›† (>100K)**: nprobe = 5-20% of nlist

### 3. æŸ¥è¯¢ç‰¹å¾
- **æŸ¥è¯¢é è¿‘èšç±»ä¸­å¿ƒ**: è¾ƒå° nprobe å³å¯
- **æŸ¥è¯¢åœ¨èšç±»è¾¹ç•Œ**: éœ€è¦è¾ƒå¤§ nprobe

## è‡ªåŠ¨è°ƒä¼˜è„šæœ¬

```bash
# 1. è¿è¡Œè°ƒä¼˜å·¥å…·
python tools/nprobe_tuner.py --benchmark --scale 50000 --target-recall 0.95 --output tune_result.json

# 2. æ ¹æ®ç»“æœé€‰æ‹© nprobe
# è¾“å‡ºä¼šæ˜¾ç¤ºä¸åŒ nprobe çš„å¬å›ç‡å’Œé€Ÿåº¦

# 3. åœ¨ä»£ç ä¸­åº”ç”¨
nprobe = 800  # æ ¹æ®è°ƒä¼˜ç»“æœ
backend.set_nprobe(nprobe)
```

## å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆ nprobe=nlist æ—¶å¬å›ç‡ä¸æ˜¯ 100%ï¼Ÿ
**A**: IVF ç´¢å¼•æœç´¢æ—¶ä¼šå…ˆå°†æŸ¥è¯¢å‘é‡åˆ†é…åˆ°æœ€è¿‘çš„èšç±»ï¼Œå¦‚æœæŸ¥è¯¢æ°å¥½åœ¨èšç±»è¾¹ç•Œé™„è¿‘ï¼Œå¯èƒ½ä¼šé”™è¿‡æ­£ç¡®çš„èšç±»ã€‚è¦è¾¾åˆ° 100% å¬å›ç‡ï¼Œéœ€è¦ä½¿ç”¨ Flat ç²¾ç¡®ç´¢å¼•ã€‚

### Q: nprobe å¢åŠ åé€Ÿåº¦ä¸‹é™å¤šå°‘ï¼Ÿ
**A**: åœ¨ GPU ä¸Šï¼Œnprobe ä» 1 å¢åŠ åˆ° 1000ï¼Œé€Ÿåº¦é€šå¸¸åªä¸‹é™ 2-3xã€‚è¿™æ˜¯å› ä¸º GPU çš„å¹¶è¡Œè®¡ç®—èƒ½åŠ›å¾ˆå¼ºï¼ŒæŸ¥è¯¢å¤šä¸ªèšç±»çš„å¼€é”€ç›¸å¯¹è¾ƒå°ã€‚

### Q: å¦‚ä½•åœ¨ä¸é™ä½å¬å›ç‡çš„æƒ…å†µä¸‹æé«˜é€Ÿåº¦ï¼Ÿ
**A**: 
1. ä½¿ç”¨æ›´å¥½çš„èšç±»ç®—æ³•ï¼ˆå¢åŠ è®­ç»ƒæ•°æ®ï¼‰
2. å°è¯• IVFPQ ç´¢å¼•ï¼ˆå‹ç¼©å­˜å‚¨ï¼‰
3. ä½¿ç”¨æ›´å°çš„ nlistï¼ˆæ›´å¤šå‘é‡ per èšç±»ï¼‰
4. è€ƒè™‘ä½¿ç”¨ HNSW ç´¢å¼•ï¼ˆANN åœºæ™¯ï¼‰

## æ€»ç»“

| ç›®æ ‡å¬å›ç‡ | æ¨è nprobe | é€‚ç”¨åœºæ™¯ |
|-----------|------------|---------|
| 60% | nlist * 8% | å¿«é€Ÿé¢„è§ˆ |
| 80% | nlist * 32% | å¹³è¡¡æœç´¢ |
| **95%** | **nlist * 64%** | **æ¨èé»˜è®¤å€¼** |
| 99% | nlist * 80% | é«˜ç²¾åº¦æœç´¢ |

ä½¿ç”¨ `backend.recommend_nprobe(target_recall)` è·å–é’ˆå¯¹ä½ çš„ç´¢å¼•çš„æ¨èå€¼ï¼Œæˆ–ä½¿ç”¨ `tools/nprobe_tuner.py` è¿›è¡Œç²¾ç¡®è°ƒä¼˜ã€‚
